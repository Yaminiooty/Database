---

- name: Check if table exists
  shell:
    cmd: |
      mysql -u admin -pPassword@123 -N -s -e 'USE LZ; SELECT 1 FROM information_schema.tables WHERE table_schema = "LZ" AND table_name = "idiots" LIMIT 1;'
  register: table_check_output
  failed_when: false
  changed_when: table_check_output.rc == 0

- name: Display message if table exists
  debug:
    msg: "Table 'idiots' already exists."
  when: table_check_output.rc == 0

- name: Create table if it doesn't exist
  command:
    cmd: |
      mysql -u admin -pPassword@123 -e '
      USE LZ;
      CREATE TABLE idiots (
        id INT AUTO_INCREMENT PRIMARY KEY,
        name VARCHAR(50) NOT NULL,
        email VARCHAR(100) NOT NULL UNIQUE
      );
      '
  when: table_check_output.rc != 0

- name: Insert records into table
  command:
    cmd: |
      mysql -u admin -pPassword@123 -e '
      USE LZ;
      INSERT INTO idiots (name, email) VALUES ("Ashok", "Ashok@example.com");
      INSERT INTO idiots (name, email) VALUES ("Gopi", "Gopih@example.com");
      '
  register: insert_output
  failed_when: insert_output.rc != 0 or "'Duplicate entry' in insert_output.stderr"

- name: Display message for duplicate key
  debug:
    msg: "Duplicate key violation occurred."
  when: "'Duplicate entry' in insert_output.stderr"



